var C=Object.defineProperty,A=Object.defineProperties;var M=Object.getOwnPropertyDescriptors;var P=Object.getOwnPropertySymbols;var V=Object.prototype.hasOwnProperty,F=Object.prototype.propertyIsEnumerable;var q=(r,e,t)=>e in r?C(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,c=(r,e)=>{for(var t in e||(e={}))V.call(e,t)&&q(r,t,e[t]);if(P)for(var t of P(e))F.call(e,t)&&q(r,t,e[t]);return r},S=(r,e)=>A(r,M(e));import{aa as o,ab as m,cT as G,ac as _,q as R,r as g,dJ as T,cq as L,c_ as D,s as N,di as O,E as Q}from"./vendor.4dd88096.js";import{t as z}from"./BitmapContainer.f6e0a6ee.js";import{f as H,u as W}from"./LayerView.c7dfc767.js";import{r as j}from"./BaseGraphicContainer.06e90be8.js";import{n as k}from"./HighlightGraphicContainer.a3c6ac41.js";import{S as J}from"./ExportStrategy.53ea1a69.js";import{c as B}from"./ExportImageParameters.841c3fea.js";import{s as K,a as X}from"./drapedUtils.731e8c30.js";import{t as Y,d as Z}from"./popupUtils.e82cd601.js";import{i as ee}from"./RefreshableLayerView.b3a54364.js";import"./WGLContainer.c9c15fea.js";import"./enums.457e23f9.js";import"./pixelUtils.1d93d897.js";import"./Container.9089f1b2.js";import"./VertexArrayObject.3d1072dc.js";import"./Texture.5cc992b3.js";import"./VertexElementDescriptor.0406f2d4.js";import"./enums.84480fc7.js";import"./Utils.9fa24473.js";import"./ProgramTemplate.315ac4f9.js";import"./StyleDefinition.809d5a5e.js";import"./config.bd364997.js";import"./GeometryUtils.5ea26345.js";import"./MaterialKey.e967c454.js";import"./earcut.91e104de.js";import"./CIMSymbolHelper.1b9868e3.js";import"./BidiEngine.b9926823.js";import"./GeometryUtils.e53da643.js";import"./projectionSupport.1f2e9c45.js";import"./json.da51edc4.js";import"./FeatureContainer.5ec8e69e.js";import"./TileContainer.0e27a280.js";import"./visualVariablesUtils.77e2c643.js";import"./visualVariablesUtils.985ba3a7.js";import"./Matcher.ad38a2a9.js";import"./tileUtils.3b62fb45.js";import"./TileClipper.78e3d1a7.js";import"./Geometry.e891c191.js";import"./ExpandedCIM.dbb41408.js";import"./quantizationUtils.cd7a121d.js";import"./devEnvironmentUtils.f51567b1.js";import"./schemaUtils.9eb3ba39.js";import"./createSymbolSchema.f2b5884a.js";import"./MD5.67d7a872.js";import"./util.972ab664.js";import"./ComputedAttributeStorage.caf3da01.js";import"./vec3f32.8179e08f.js";import"./Bitmap.e283ec4c.js";import"./sublayerUtils.fcecddac.js";const te=r=>{let e=class extends r{initialize(){this.exportImageParameters=new B({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var t;return(t=this.exportImageParameters)==null||t.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}async fetchPopupFeatures(t,a){const{layer:h}=this;if(!t)return Promise.reject(new R("mapimagelayerview:fetchPopupFeatures","Nothing to fetch without area",{layer:h}));const l=this.get("view.scale"),y=[],f=async i=>{const p=i.minScale===0||l<=i.minScale,s=i.maxScale===0||l>=i.maxScale;if(i.visible&&p&&s){if(i.sublayers)i.sublayers.forEach(f);else if(i.popupEnabled){const d=Z(i,S(c({},a),{defaultPopupTemplateEnabled:!1}));g(d)&&y.unshift({sublayer:i,popupTemplate:d})}}},E=h.sublayers.toArray().reverse().map(f);await Promise.all(E);const U=y.map(async({sublayer:i,popupTemplate:p})=>{await i.load().catch(()=>{});const s=i.createQuery(),d=g(a)?a.event:null,v=K({renderer:i.renderer,event:d}),w=this.createFetchPopupFeaturesQueryGeometry(t,v);if(s.geometry=w,s.outFields=await Y(i,p),this.layer.type==="map-image"&&"floors"in this.view){var x,I;const $=(x=this.view)==null||(I=x.floors)==null?void 0:I.clone(),u=T($,i);g(u)&&(s.where=s.where?`(${s.where}) AND (${u})`:u)}const b=await this._loadArcadeModules(p);return b&&b.arcadeUtils.hasGeometryOperations(p)||(s.maxAllowableOffset=w.width/v),(await i.queryFeatures(s)).features});return(await L(U)).reduce((i,p)=>p.value?[...i,...p.value]:i,[]).filter(i=>i!=null)}canResume(){var t;return!!super.canResume()&&((t=this.timeExtent)==null||!t.isEmpty)}_loadArcadeModules(t){if(t.get("expressionInfos.length")||Array.isArray(t.content)&&t.content.some(a=>a.type==="expression"))return D()}};return o([m()],e.prototype,"exportImageParameters",void 0),o([m({readOnly:!0})],e.prototype,"exportImageVersion",null),o([m()],e.prototype,"layer",void 0),o([m()],e.prototype,"suspended",void 0),o([m(G)],e.prototype,"timeExtent",void 0),e=o([_("esri.views.layers.MapImageLayerView")],e),e},re=N.getLogger("esri.views.2d.layers.MapImageLayerView2D");let n=class extends te(ee(H(W))){constructor(){super(...arguments),this._highlightGraphics=new O}update(r){this.strategy.update(r).catch(e=>{Q(e)||re.error(e)})}attach(){const{imageMaxWidth:r,imageMaxHeight:e,version:t}=this.layer,a=t>=10.3,h=t>=10;this._bitmapContainer=new z,this.container.addChild(this._bitmapContainer);const l=new j({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new k(this.view.featuresTilingScheme)});this.container.addChild(l.container),this.strategy=new J({container:this._bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:r,imageMaxHeight:e,imageRotationSupported:a,imageNormalizationSupported:h,hidpi:!0}),this.handles.add(this.watch("exportImageVersion",()=>this.requestUpdate()),"exportImageVersion"),this.handles.add(this.watch("view.floors",()=>this.requestUpdate()),"view.floors"),this.requestUpdate()}detach(){this.handles.remove("exportImageVersion"),this.handles.remove("view.floors"),this.strategy.destroy(),this.container.removeAllChildren(),this._bitmapContainer.removeAllChildren()}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}highlight(r,e){return this._highlightGraphics.add(r),{remove:()=>{this._highlightGraphics.remove(r)}}}supportsSpatialReference(r){return this.layer.serviceSupportsSpatialReference(r)}createFetchPopupFeaturesQueryGeometry(r,e){return X(r,e,this.view)}async doRefresh(){this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(r,e,t,a){return this.layer.fetchImage(r,e,t,c({timeExtent:this.timeExtent,floors:this.view.floors},a))}};o([m()],n.prototype,"strategy",void 0),o([m()],n.prototype,"updating",void 0),n=o([_("esri.views.2d.layers.MapImageLayerView2D")],n);const Ze=n;export{Ze as default};
