var Ot=Object.defineProperty,Tt=Object.defineProperties;var yt=Object.getOwnPropertyDescriptors;var nt=Object.getOwnPropertySymbols;var vt=Object.prototype.hasOwnProperty,Dt=Object.prototype.propertyIsEnumerable;var ot=(t,e,n)=>e in t?Ot(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,rt=(t,e)=>{for(var n in e||(e={}))vt.call(e,n)&&ot(t,n,e[n]);if(nt)for(var n of nt(e))Dt.call(e,n)&&ot(t,n,e[n]);return t},st=(t,e)=>Tt(t,yt(e));import{n as Lt}from"./deduplicate.a22bcc58.js";import{y as Vt,u as Mt,i as bt,c as Pt,l as Rt,p as Ut,o as Ft,m as xt,T as Bt,h as Ct,a as Ht,b as Wt,d as kt,A as Gt,O as zt,x as Kt,g as Xt,w as _t,E as qt,L as jt,B as Jt,F as Yt,I as Qt,U as Zt,j as te,V as ee,M as ne,S as oe,k as re,q as se,v as ie,z as ae,C as ce,D as fe,G as le,H as ue}from"./BufferView.c4c38763.js";import{f4 as ge,f5 as mt,af as O,c8 as de,dk as it,f6 as pe,f7 as me,ag as W,f8 as at,f9 as G,fa as ht,fb as he,fc as Ne,fd as ct,fe as $e}from"./vendor.4dd88096.js";import{C as L}from"./enums.457e23f9.js";import{t as Ae}from"./VertexElementDescriptor.0406f2d4.js";import{T as j}from"./InterleavedLayout.42db43a1.js";import{O as p}from"./VertexAttribute.ebaf629c.js";import"./types.ba25b516.js";function ft(t,e,n){const s=e/3,r=new Uint32Array(n+1),a=new Uint32Array(n+1),d=(o,i)=>{o<i?r[o+1]++:a[i+1]++};for(let o=0;o<s;o++){const i=t[3*o],u=t[3*o+1],g=t[3*o+2];d(i,u),d(u,g),d(g,i)}let c=0,m=0;for(let o=0;o<n;o++){const i=r[o+1],u=a[o+1];r[o+1]=c,a[o+1]=m,c+=i,m+=u}const f=new Uint32Array(6*s),l=r[n],N=(o,i,u)=>{if(o<i){const g=r[o+1]++;f[2*g]=i,f[2*g+1]=u}else{const g=a[i+1]++;f[2*l+2*g]=o,f[2*l+2*g+1]=u}};for(let o=0;o<s;o++){const i=t[3*o],u=t[3*o+1],g=t[3*o+2];N(i,u,o),N(u,g,o),N(g,i,o)}const $=(o,i)=>{const u=2*o,g=i-o;for(let I=1;I<g;I++){const E=f[u+2*I],v=f[u+2*I+1];let w=I-1;for(;w>=0&&f[u+2*w]>E;w--)f[u+2*w+2]=f[u+2*w],f[u+2*w+3]=f[u+2*w+1];f[u+2*w+2]=E,f[u+2*w+3]=v}};for(let o=0;o<n;o++)$(r[o],r[o+1]),$(l+a[o],l+a[o+1]);const h=new Int32Array(3*s),T=(o,i)=>o===t[3*i]?0:o===t[3*i+1]?1:o===t[3*i+2]?2:-1,A=(o,i)=>{const u=T(o,i);h[3*i+u]=-1},y=(o,i,u,g)=>{const I=T(o,i);h[3*i+I]=g;const E=T(u,g);h[3*g+E]=i};for(let o=0;o<n;o++){let i=r[o];const u=r[o+1];let g=a[o];const I=a[o+1];for(;i<u&&g<I;){const E=f[2*i],v=f[2*l+2*g];E===v?(y(o,f[2*i+1],v,f[2*l+2*g+1]),i++,g++):E<v?(A(o,f[2*i+1]),i++):(A(v,f[2*l+2*g+1]),g++)}for(;i<u;)A(o,f[2*i+1]),i++;for(;g<I;)A(f[2*l+2*g],f[2*l+2*g+1]),g++}return h}function lt(t,e){return e.push(t.buffer),{buffer:t.buffer,layout:Ie(t.layout)}}function Ie(t){const e=new Array;return t.fields.forEach((n,s)=>{const r=st(rt({},n),{constructor:Nt(n.constructor)});e.push([s,r])}),{stride:t.stride,fields:e,fieldNames:t.fieldNames}}const we=[Vt,Mt,bt,Pt,Rt,Ut,Ft,xt,Bt,Ct,Ht,Wt,kt,Gt,zt,Kt,Xt,_t,qt,jt,Jt,Yt,Qt,Zt,te,ee,ne,oe,re,se,ie,ae,ce,fe,le,ue];function Nt(t){return`${t.ElementType}_${t.ElementCount}`}const Se=new Map;we.forEach(t=>Se.set(Nt(t),t));function J(t,e=0){const n=t.stride;return t.fieldNames.filter(s=>{const r=t.fields.get(s).optional;return!(r&&r.glPadding)}).map(s=>{const r=t.fields.get(s),a=r.constructor.ElementCount,d=Ee(r.constructor.ElementType),c=r.offset,m=!(!r.optional||!r.optional.glNormalized);return new Ae(s,a,d,c,n,m,e)})}function Ee(t){const e=Oe[t];if(e)return e;throw new Error("BufferType not supported in WebGL")}const Oe={u8:L.UNSIGNED_BYTE,u16:L.UNSIGNED_SHORT,u32:L.UNSIGNED_INT,i8:L.BYTE,i16:L.SHORT,i32:L.INT,f32:L.FLOAT},$t=j().vec3f(p.POSITION).u16(p.COMPONENTINDEX).u16(p.U16PADDING),Te=j().vec2u8(p.SIDENESS);J(Te);const At=j().vec3f(p.POSITION0).vec3f(p.POSITION1).u16(p.COMPONENTINDEX).u8(p.VARIANTOFFSET,{glNormalized:!0}).u8(p.VARIANTSTROKE).u8(p.VARIANTEXTENSION,{glNormalized:!0}).u8(p.U8PADDING,{glPadding:!0}).u16(p.U16PADDING,{glPadding:!0}),z=At.clone().vec3f(p.NORMAL),K=At.clone().vec3f(p.NORMALA).vec3f(p.NORMALB);p.POSITION0,p.POSITION1,p.COMPONENTINDEX,p.VARIANTOFFSET,p.VARIANTSTROKE,p.VARIANTEXTENSION,p.NORMAL,p.NORMALA,p.NORMALB,p.SIDENESS;class It{updateSettings(e){this.settings=e,this.edgeHashFunction=e.reducedPrecision?ve:ye}write(e,n,s){const r=this.edgeHashFunction(s);B.seed=r;const a=B.getIntRange(0,255),d=B.getIntRange(0,this.settings.variants-1),c=.7,m=B.getFloat(),f=255*(.5*De(-(1-Math.min(m/c,1))+Math.max(0,m-c)/(1-c),1.2)+.5);e.position0.setVec(n,s.position0),e.position1.setVec(n,s.position1),e.componentIndex.set(n,s.componentIndex),e.variantOffset.set(n,a),e.variantStroke.set(n,d),e.variantExtension.set(n,f)}trim(e,n){return e.slice(0,n)}}const Y=new Float32Array(6),C=new Uint32Array(Y.buffer),D=new Uint32Array(1);function ye(t){const e=Y;e[0]=t.position0[0],e[1]=t.position0[1],e[2]=t.position0[2],e[3]=t.position1[0],e[4]=t.position1[1],e[5]=t.position1[2],D[0]=5381;for(let n=0;n<C.length;n++)D[0]=31*D[0]+C[n];return D[0]}function ve(t){const e=Y;e[0]=P(t.position0[0]),e[1]=P(t.position0[1]),e[2]=P(t.position0[2]),e[3]=P(t.position1[0]),e[4]=P(t.position1[1]),e[5]=P(t.position1[2]),D[0]=5381;for(let n=0;n<C.length;n++)D[0]=31*D[0]+C[n];return D[0]}const ut=1e4;function P(t){return Math.round(t*ut)/ut}function De(t,e){const n=t<0?-1:1;return Math.abs(t)**e*n}class X{constructor(){this.commonWriter=new It}updateSettings(e){this.commonWriter.updateSettings(e)}allocate(e){return z.createBuffer(e)}write(e,n,s){this.commonWriter.write(e,n,s),ge(x,s.faceNormal0,s.faceNormal1),mt(x,x),e.normal.setVec(n,x)}trim(e,n){return this.commonWriter.trim(e,n)}}X.Layout=z,X.glLayout=J(z,1);class _{constructor(){this.commonWriter=new It}updateSettings(e){this.commonWriter.updateSettings(e)}allocate(e){return K.createBuffer(e)}write(e,n,s){this.commonWriter.write(e,n,s),e.normalA.setVec(n,s.faceNormal0),e.normalB.setVec(n,s.faceNormal1)}trim(e,n){return this.commonWriter.trim(e,n)}}_.Layout=K,_.glLayout=J(K,1);const x=O(),B=new de,V=-1;var gt;function Le(t,e,n,s=Ue){const r=t.vertices.position,a=t.vertices.componentIndex,d=it(s.anglePlanar),c=it(s.angleSignificantEdge),m=Math.cos(c),f=Math.cos(d),l=q.edge,N=l.position0,$=l.position1,h=l.faceNormal0,T=l.faceNormal1,A=Re(t),y=Pe(t),o=y.length/4,i=e.allocate(o);let u=0;const g=o,I=n.allocate(g);let E=0,v=0,w=0;const Q=pe(0,o),U=new Float32Array(o);me(U,(M,S,R)=>{r.getVec(y[4*S+0],N),r.getVec(y[4*S+1],$),R[S]=$e(N,$)}),Q.sort((M,S)=>U[S]-U[M]);const Z=new Array,tt=new Array;for(let M=0;M<o;M++){const S=Q[M],R=U[S],H=y[4*S+0],Et=y[4*S+1],b=y[4*S+2],F=y[4*S+3],et=F===V;if(r.getVec(H,N),r.getVec(Et,$),et)W(h,A[3*b+0],A[3*b+1],A[3*b+2]),at(T,h),l.componentIndex=a.get(H),l.cosAngle=G(h,T);else{if(W(h,A[3*b+0],A[3*b+1],A[3*b+2]),W(T,A[3*F+0],A[3*F+1],A[3*F+2]),l.componentIndex=a.get(H),l.cosAngle=G(h,T),Me(l,f))continue;l.cosAngle<-.9999&&at(T,h)}v+=R,w++,et||Ve(l,m)?(e.write(i,u++,l),Z.push(R)):be(l,d)&&(n.write(I,E++,l),tt.push(R))}const wt=new Float32Array(Z.reverse()),St=new Float32Array(tt.reverse());return{regular:{instancesData:e.trim(i,u),lodInfo:{lengths:wt}},silhouette:{instancesData:n.trim(I,E),lodInfo:{lengths:St}},averageEdgeLength:v/w}}function Ve(t,e){return t.cosAngle<e}function Me(t,e){return t.cosAngle>e}function be(t,e){const n=he(t.cosAngle),s=q.fwd,r=q.ortho;return Ne(s,t.position1,t.position0),n*(G(ht(r,t.faceNormal0,t.faceNormal1),s)>0?-1:1)>e}function Pe(t){const e=t.faces.length/3,n=t.faces,s=t.neighbors;let r=0;for(let c=0;c<e;c++){const m=s[3*c+0],f=s[3*c+1],l=s[3*c+2],N=n[3*c+0],$=n[3*c+1],h=n[3*c+2];r+=m===V||N<$?1:0,r+=f===V||$<h?1:0,r+=l===V||h<N?1:0}const a=new Int32Array(4*r);let d=0;for(let c=0;c<e;c++){const m=s[3*c+0],f=s[3*c+1],l=s[3*c+2],N=n[3*c+0],$=n[3*c+1],h=n[3*c+2];(m===V||N<$)&&(a[d++]=N,a[d++]=$,a[d++]=c,a[d++]=m),(f===V||$<h)&&(a[d++]=$,a[d++]=h,a[d++]=c,a[d++]=f),(l===V||h<N)&&(a[d++]=h,a[d++]=N,a[d++]=c,a[d++]=l)}return a}function Re(t){const e=t.faces.length/3,n=t.vertices.position,s=t.faces,r=k.v0,a=k.v1,d=k.v2,c=new Float32Array(3*e);for(let m=0;m<e;m++){const f=s[3*m+0],l=s[3*m+1],N=s[3*m+2];n.getVec(f,r),n.getVec(l,a),n.getVec(N,d),ct(a,a,r),ct(d,d,r),ht(r,a,d),mt(r,r),c[3*m+0]=r[0],c[3*m+1]=r[1],c[3*m+2]=r[2]}return c}(function(t){t[t.SOLID=0]="SOLID",t[t.SKETCH=1]="SKETCH"})(gt||(gt={}));const q={edge:{position0:O(),position1:O(),faceNormal0:O(),faceNormal1:O(),componentIndex:0,cosAngle:0},ortho:O(),fwd:O()},k={v0:O(),v1:O(),v2:O()},Ue={anglePlanar:4,angleSignificantEdge:35};async function je(t){const e=xe(t),n=Fe(e),s=[e.data.buffer];return{result:Be(n,s),transferList:s}}function Fe(t){const e=Ce(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return dt.updateSettings(t.writerSettings),pt.updateSettings(t.writerSettings),Le(e,dt,pt)}function xe(t){return{data:$t.createView(t.dataBuffer),indices:t.indicesType==="Uint32Array"?new Uint32Array(t.indicesBuffer):t.indicesType==="Uint16Array"?new Uint16Array(t.indicesBuffer):void 0,indicesLength:t.indicesLength,writerSettings:t.writerSettings,skipDeduplicate:t.skipDeduplicate}}function Be(t,e){return e.push(t.regular.lodInfo.lengths.buffer),e.push(t.silhouette.lodInfo.lengths.buffer),{regular:{instancesData:lt(t.regular.instancesData,e),lodInfo:{lengths:t.regular.lodInfo.lengths.buffer}},silhouette:{instancesData:lt(t.silhouette.instancesData,e),lodInfo:{lengths:t.silhouette.lodInfo.lengths.buffer}},averageEdgeLength:t.averageEdgeLength}}function Ce(t,e,n,s){if(e)return{faces:n,facesLength:s,neighbors:ft(n,s,t.count),vertices:t};const r=Lt(t.buffer,t.stride/4,{originalIndices:n,originalIndicesLength:s}),a=ft(r.indices,s,r.uniqueCount);return{faces:r.indices,facesLength:r.indices.length,neighbors:a,vertices:$t.createView(r.buffer)}}const dt=new X,pt=new _;export{Fe as work,je as wrappedWork};
